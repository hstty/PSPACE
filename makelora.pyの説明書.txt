# makelora.py 説明書

## 概要
`makelora.py` は、Paperspace (Jupyter Lab) 上で LoRA 学習を自動化するためのスクリプトです。
リモートストレージ (Google Drive 等) から学習データをダウンロードし、学習を実行し、成果物をアップロードするまでの一連の流れを自動で行います。

## 主な機能
1. **自動ダウンロード**: `rclone` を使用して、指定されたリモートパスから学習データを `working_directory` にダウンロードします。
2. **自動解凍**: ダウンロードしたファイルに ZIP ファイルが含まれている場合、自動的に解凍します。
3. **一括学習**: `working_directory` 内の各サブフォルダを 1 つの学習セット（コンセプト）として扱い、順番に学習を実行します。
4. **自動アップロード**: 学習が完了するたびに、生成された LoRA ファイル等をリモートストレージにアップロードします。
5. **自動クリーンアップ**:
    - 学習完了後、ローカルの学習データフォルダを削除し、ディスク容量を確保します。
    - リモートの学習データもダウンロード成功後に削除されます（`training` フォルダ自体は維持）。
    - Google Drive のゴミ箱を空にする機能も備えています。
6. **エラーハンドリング**:
    - **OOM (Out Of Memory) リトライ**: 学習中に CUDA Out of Memory エラーが発生した場合、自動的に `outofmemory.toml` の設定を読み込んで再試行します。
    - **モデル退避**: ディスク容量節約や速度向上のため、学習中にモデルファイルを一時ディレクトリに移動し、終了後に復元します。

## 必要なファイル構成
- `makelora.py`: 本スクリプト
- `PSPACE_env.toml`: 環境設定ファイル（パス、rclone設定、accelerate設定など）
- `rclone.conf`: rclone の設定ファイル
- `[学習設定ファイル].toml`: ベースとなる学習設定（例: `NAIL7-PSPACE.toml`）。`PSPACE_env.toml` 内で指定します。
- `outofmemory.toml` (任意): OOM 発生時の再試行用設定ファイル

## 使い方

### 基本的な実行
```bash
python makelora.py
```
`PSPACE_env.toml` の設定に従って処理を開始します。

### オプション引数

#### 1. `--test` (テストモード)
```bash
python makelora.py --test
```
- 学習完了後、ローカルの学習データフォルダ（`working_directory` 内のフォルダ）を**削除しません**。
- 動作確認やデバッグ時に使用します。

#### 2. `--add [設定ファイル]` (追加設定)
```bash
python makelora.py --add my_config.toml
```
- 指定した TOML ファイルの設定を、ベースの学習設定に上書き（マージ）して学習を実行します。
- 出力ファイル名のサフィックスに、追加設定ファイル名が付与されます。
    - 例: `output_suffix` が `v1` で、`--add test.toml` を指定した場合 -> `v1-test`

## 処理の流れ
1. **環境設定読み込み**: `PSPACE_env.toml` を読み込みます。
2. **データダウンロード**: リモートの `training` フォルダからデータをダウンロードし、リモート上のファイルを削除します。
3. **ZIP解凍**: ZIPファイルがあれば解凍します。
4. **フォルダ検出**: `working_directory` 内のフォルダをスキャンし、学習対象リストを作成します。
5. **学習ループ**: 各フォルダに対して以下を実行します。
    - 個別の設定ファイル (TOML) を生成。
    - モデルファイルを一時ディレクトリに移動（必要な場合）。
    - `accelerate launch` で学習コマンドを実行。
    - **(OOM発生時)**: `outofmemory.toml` を読み込んでリトライ。
    - モデルファイルを元の場所に復元。
    - 成果物をリモートの `output` フォルダにアップロード。
    - ローカルの出力フォルダと学習データフォルダを削除（`--test` 時はデータフォルダ削除なし）。

## 設定ファイル (`PSPACE_env.toml`) の構成例
※ 実際のファイル内容は環境に合わせて確認してください。

```toml
[paths]
base_directory = "/notebooks"
working_directory = "training" # 学習データの展開先
program_directory = "program"
output_dir = "output"
# ... その他パス設定

[rclone]
remote_path = "google:lora" # リモートのルートパス
empty_trash_after_upload = true # アップロード後にゴミ箱を空にするか

[makelora_settings]
train_config_file = "NAIL7-PSPACE.toml" # ベースの学習設定ファイル
output_suffix = "v1" # 出力ファイル名の識別子
```

## 注意事項
- **中断 (Ctrl+C)**: 実行中に中断した場合、移動されたモデルファイルが一時ディレクトリに残る可能性がありますが、スクリプトは可能な限り復元を試みます。
- **Google Drive 容量**: アップロード時に容量不足エラーが出た場合、スクリプトは停止します。
