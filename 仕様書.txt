# makelora.py 仕様書

## 1. 概要
本プログラム `makelora.py` は、LoRA (Low-Rank Adaptation) モデルの学習プロセスを自動化するためのスクリプトである。
リモートストレージからの学習データダウンロード、ZIP解凍、設定ファイルの動的生成、学習コマンドの実行（自動再試行機能付き）、学習済みモデルのアップロード、およびローカル/リモートのクリーンアップを一貫して行う。

## 2. 動作環境・依存関係
- **OS**: Windows (パス区切り文字の扱いは `os.path` で吸収)
- **言語**: Python 3.x
- **外部ライブラリ**:
  - `toml`: 設定ファイルの読み書き
  - `IPython` (オプション): Jupyter Notebook環境での出力表示用
- **外部ツール**:
  - `rclone`: リモートストレージとのファイル転送・操作
  - `accelerate`: 学習スクリプトの実行ランチャー
  - `sdxl_train_network.py`: 実際の学習スクリプト (Kohya-ss/sd-scripts等)

## 3. 入力・設定ファイル
### 3.1. コマンドライン引数
- `--add [FILENAME]`: 追加で読み込むTOML設定ファイルを指定する。
  - 指定された場合、`output_suffix` にファイル名（拡張子なし）が追記される。
  - 基本設定ファイルの内容にマージ（上書き）される。

### 3.2. 設定ファイル
- **`PSPACE_env.toml`** (必須): 環境設定ファイル。以下のセクションを含む。
  - `paths`: 各種ディレクトリパス (base, working, kohya, program, temp, outputなど)
  - `accelerate_options`: `accelerate launch` コマンドのオプション
  - `train_options`: 学習時のログプレフィックスなど
  - `makelora_settings`: `output_suffix` や基本学習設定ファイル名 (`train_config_file`)
  - `rclone`: リモートパス、ゴミ箱を空にする設定など
- **基本学習設定ファイル**: `PSPACE_env.toml` 内の `train_config_file` で指定されたTOMLファイル。学習パラメータのベースとなる。
- **`outofmemory.toml`** (オプション): メモリ不足 (OOM) エラー発生時に読み込まれる、軽量化設定などが記述されたTOMLファイル。

## 4. 処理フロー

### 4.1. 初期化
1. 環境変数 `PYTORCH_CUDA_ALLOC_CONF` を設定。
2. `PSPACE_env.toml` を読み込み、パスやオプションを展開。
3. `--add` 引数がある場合、`output_suffix` を更新し、追加設定ファイルのマージ準備を行う。

### 4.2. データ準備
1. **リモートダウンロード**:
   - `rclone` を使用して、指定されたリモートパス (`remote_path/training`) から `working_directory` へファイルをダウンロード。
   - ダウンロード成功後、リモートの `training` フォルダ内のファイルを削除（フォルダ構造は維持しようと試みる）。
2. **ZIP解凍**:
   - `working_directory` 内の `.zip` ファイルを検索し、その場で解凍。
   - 解凍成功後、元の `.zip` ファイルは削除。
3. **処理対象検出**:
   - `working_directory` 内のサブディレクトリを走査し、処理対象リストを作成。
   - ドット (`.`) で始まるフォルダやファイルはスキップ。

### 4.3. 学習ループ
検出された各フォルダに対して以下の処理を順次実行する。

1. **設定生成**:
   - 基本設定（＋追加設定）をコピー。
   - `train_data_dir` (学習データパス), `output_name`, `output_dir` をフォルダごとに設定。
   - `pretrained_model_name_or_path` (事前学習モデル) のパス処理：
     - パフォーマンス向上のため、モデルファイルを一時ディレクトリ (`temp_directory`) に移動またはコピーして使用。
   - 一時的な設定ファイル (`{folder}_{output_suffix}.toml`) を保存。

2. **学習実行 (`accelerate launch`)**:
   - 構築したコマンドを実行。
   - **リアルタイム出力**: 標準出力・標準エラー出力をリアルタイムで表示（Jupyter環境では表示エリアを更新）。
   - **自動再試行 (Retry)**:
     - `CUDA out of memory` 等のOOMエラーを検知した場合、`outofmemory.toml` を読み込んで設定を上書きし、再実行する。

3. **学習後処理**:
   - **モデル復元**: 一時ディレクトリに移動していた事前学習モデルを元の場所に戻す。
   - **成功時**:
     - **アップロード**: 学習結果 (`output_dir`) を `rclone` でリモート (`remote_path/output`) にアップロード。
       - 容量超過エラー (`storageQuotaExceeded`) を検知した場合、処理を中断。
     - **リモートクリーンアップ**: 設定により、Google Driveのゴミ箱を空にする (`rclone cleanup`)。
     - **ローカルクリーンアップ**:
       - `output_dir` の中身を削除。
       - 学習データフォルダ (`working_directory/{folder}`) を削除。
       - 一時設定ファイルを削除。
   - **失敗時**:
     - エラーログを表示。
     - フォルダや一時ファイルは削除せずに残す（デバッグ用）。

### 4.4. 終了処理
- 全てのフォルダの処理完了後、結果の要約を表示。
  - 正常に処理・削除されたフォルダ
  - エラー等で残ったフォルダ
  - 最初からスキップされたエントリ

## 5. エラーハンドリング
- 必須ファイルの欠落 (`PSPACE_env.toml`, `working_directory` 等) は即座にエラー終了。
- 個別のフォルダ処理中のエラーは、そのフォルダのみをスキップし、次のフォルダの処理へ移行する（全体を止めない）。
- Google Driveの容量超過など、継続不可能なエラーは即座に終了。

## 6. ログ・出力
- 標準出力に処理の進捗、実行コマンド、学習ログを表示。
- Jupyter Notebook 上での実行を想定し、出力表示の更新制御を行っている。
